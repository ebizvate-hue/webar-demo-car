<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>AR Video موبایل و دسکتاپ</title>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image-three.prod.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #fff;
      font-family: sans-serif;
    }
    #ar-container {
      width: 100vw;
      height: 100vh;
      position: relative;
    }
    video {
      display: none; /* ویدیو در صفحه مخفی است */
    }
  </style>
</head>
<body>

<div id="ar-container"></div>

<!-- ویدیو با صدا -->
<video id="video" src="sample.mp4" loop playsinline webkit-playsinline></video>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const video = document.getElementById("video");
  video.muted = false; // صدای ویدیو فعال

  const mindarThree = new window.MINDAR.IMAGE.MindARThree({
    container: document.querySelector("#ar-container"),
    imageTargetSrc: "targets.mind",
    maxTrack: 1
  });

  const {renderer, scene, camera} = mindarThree;

  // VideoTexture
  const texture = new THREE.VideoTexture(video);
  texture.minFilter = THREE.LinearFilter;
  texture.magFilter = THREE.LinearFilter;
  texture.format = THREE.RGBFormat;

  // Anchor
  const anchor = mindarThree.addAnchor(0);

  // وقتی target لود شد، اندازه واقعی آن را می‌گیریم
  anchor.onTargetLoaded = () => {
    const targetWidth = anchor.target.width;
    const targetHeight = anchor.target.height;

    // Plane هم اندازه target
    const geometry = new THREE.PlaneGeometry(targetWidth, targetHeight);
    const material = new THREE.MeshBasicMaterial({map: texture});
    const videoPlane = new THREE.Mesh(geometry, material);
    videoPlane.visible = false; // قبل از شناسایی مخفی

    // اضافه کردن به anchor
    anchor.group.add(videoPlane);

    // وقتی تصویر شناسایی شد
    anchor.onTargetFound = () => {
      videoPlane.visible = true;
      // برای موبایل: ویدیو بدون تعامل کار نمی‌کند، بنابراین صدا ممکن است نیاز به تعامل کاربر داشته باشد
      video.play().catch(() => console.log("لطفا روی صفحه لمس کنید تا صدا پخش شود"));
    };

    // وقتی تصویر از زاویه دوربین خارج شد
    anchor.onTargetLost = () => {
      videoPlane.visible = false;
      video.pause();
      video.currentTime = 0;
    };
  };

  mindarThree.start();
  renderer.setAnimationLoop(() => {
    renderer.render(scene, camera);
  });
});
</script>

</body>
</html>
